# Project Structure for IPA Build

This repository contains both a Swift Package (Requestify) and an iOS application (RequestifyApp) that uses it.

## Directory Structure

```
poc-ios/
├── Package.swift                    # Swift Package manifest for Requestify library
├── Sources/
│   └── Requestify/                  # Library source code
│       ├── Requestify.swift
│       ├── Params.swift
│       └── Utils/
├── Tests/
│   └── RequestifyTests/             # Library tests
├── RequestifyApp/                   # iOS App that uses Requestify
│   ├── project.yml                  # XcodeGen specification
│   ├── RequestifyApp/
│   │   ├── AppDelegate.swift
│   │   ├── ViewController.swift
│   │   └── Info.plist
│   └── RequestifyApp.xcodeproj      # Generated by XcodeGen (not committed)
├── exportOptions.plist              # IPA export configuration
└── .github/workflows/swift.yml      # CI/CD workflow
```

## How the Build Works

### 1. Swift Package Build & Test
- Runs `swift build -v` to build the Requestify library for macOS
- Runs `swift test --enable-code-coverage -v` to test the library

### 2. iOS App Project Generation
- Installs XcodeGen via Homebrew
- Generates `RequestifyApp/RequestifyApp.xcodeproj` from `RequestifyApp/project.yml`
- The generated project links to the Requestify package in the parent directory

### 3. Code Signing (Optional)
If you provide these GitHub Secrets, the workflow will sign the app:
- `APPLE_TEAM_ID` - Your Apple Developer Team ID
- `APP_BUNDLE_ID` - Bundle identifier (e.g., com.example.requestifyapp)
- `SIGNING_CERT_BASE64` - Base64-encoded .p12 certificate
- `SIGNING_CERT_PASSWORD` - Password for the .p12 file
- `PROVISIONING_PROFILE_BASE64` - Base64-encoded .mobileprovision file
- `PROVISIONING_PROFILE_NAME` - Name of the provisioning profile

When all secrets are present:
- Creates a temporary keychain
- Imports the signing certificate
- Installs the provisioning profile
- Generates a signed exportOptions.plist
- Archives with CODE_SIGN_STYLE=Manual

When secrets are missing:
- Archives with CODE_SIGNING_ALLOWED=NO
- Creates an unsigned archive

### 4. IPA Export
- **Signed build**: Uses `xcodebuild -exportArchive` with proper signing
- **Unsigned build**: Attempts export, then falls back to manual IPA packaging

### 5. Fallback IPA Packaging
If exportArchive fails (common for unsigned builds):
- Extracts the .app from the archive
- Creates a Payload/ folder
- Zips it as `Requestify-unsigned.ipa`
- Uploads as artifact

### 6. Artifacts
The workflow uploads:
- `Requestify-iOS` - The IPA file (signed or unsigned)
- `xcode-export-logs` - Distribution logs if export failed (for debugging)

## Local Development

### Build the library:
```bash
swift build
swift test
```

### Generate and build the iOS app:
```bash
cd RequestifyApp
xcodegen generate
xcodebuild -project RequestifyApp.xcodeproj -scheme RequestifyApp -destination 'generic/platform=iOS' archive
```

### Or open in Xcode:
```bash
cd RequestifyApp
xcodegen generate
open RequestifyApp.xcodeproj
```

## Bundle ID Configuration

The app bundle ID is set in `RequestifyApp/project.yml`:
```yaml
PRODUCT_BUNDLE_IDENTIFIER: com.example.requestifyapp
```

If you provide `APP_BUNDLE_ID` secret, it will override this during the signed archive step.

## Next Steps

1. **For unsigned builds**: The current setup works as-is. Just push and the workflow will create an unsigned IPA.

2. **For signed builds**: Add the required secrets to your GitHub repository:
   - Go to Settings > Secrets and variables > Actions
   - Add all 6 secrets listed above
   - Push to trigger a signed build

3. **Custom Bundle ID**: Update `RequestifyApp/project.yml` or provide `APP_BUNDLE_ID` secret

4. **Add more features**: Modify `RequestifyApp/RequestifyApp/ViewController.swift` to demonstrate more Requestify features
