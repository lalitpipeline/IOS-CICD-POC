# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: XCodeTest

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # Install any dependencies
    - name: Install Dependencies
      run: swift package resolve

    # Setup iOS simulator
    - name: Setup iOS Simulator
      run: |
        # Get the latest available iOS runtime
        RUNTIME=$(xcrun simctl list runtimes | grep iOS | tail -n1 | cut -d ' ' -f6)
        echo "Available Runtime: $RUNTIME"
        
        # Create and boot simulator
        UDID=$(xcrun simctl create "iOS-Test" "iPhone 14" "$RUNTIME")
        xcrun simctl boot "$UDID"
        echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
        
        # Show the created simulator
        xcrun simctl list devices | grep "iOS-Test"

    # Build and Test for iOS
    - name: Build and Test
      run: |
        # First, build for generic iOS device
        xcodebuild clean build \
          -scheme 'Requestify' \
          -destination 'generic/platform=iOS' \
          -configuration Release

        # Then run tests on simulator
        xcodebuild test \
          -scheme 'Requestify' \
          -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
          -configuration Release \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults.xcresult

    # Create Archive
    - name: Create Archive
      run: |
        xcodebuild archive \
          -scheme 'Requestify' \
          -destination 'generic/platform=iOS' \
          -archivePath $RUNNER_TEMP/Requestify.xcarchive \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO

    # Create IPA
    - name: Create IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/Requestify.xcarchive \
          -exportPath $RUNNER_TEMP/Requestify \
          -exportOptionsPlist exportOptions.plist

    # Upload IPA as artifact
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Requestify-iOS
        path: ${{ runner.temp }}/Requestify/*.ipa
        retention-days: 5
