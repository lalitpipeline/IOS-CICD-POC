# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: XCodeTest

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # Install any dependencies
    - name: Install Dependencies
      run: swift package resolve

    # Setup iOS simulator (find an available destination via xcodebuild)
    - name: Setup iOS Simulator
      run: |
        set -e
        echo "Finding an iOS Simulator destination for scheme 'Requestify-Package'..."
        xcodebuild -scheme 'Requestify-Package' -showdestinations || true
        # Prefer a real simulator UDID (UUID format), ignore placeholder ids
        UDID=$(xcodebuild -scheme 'Requestify-Package' -showdestinations \
          | awk -F'id:' '/platform:iOS Simulator/ { gsub(/[ ,}]/, "", $2); if($2 ~ /^[0-9A-Fa-f-]{36}$/){ print $2; exit } }')
        if [ -z "$UDID" ]; then
          echo "No simulator UDID found from showdestinations. Tests will be skipped."
        else
          echo "Found Simulator UDID: $UDID"
        fi
        echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV

    # Build and Test for iOS
    - name: Build and Test
      run: |
        # First, build for generic iOS device (SPM scheme)
        xcodebuild clean build \
          -scheme 'Requestify-Package' \
          -destination 'generic/platform=iOS' \
          -configuration Release

        # Then run tests on simulator (if destination found)
        if [ -n "$SIMULATOR_UDID" ]; then
          xcodebuild test \
            -scheme 'Requestify-Package' \
            -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
            -configuration Release \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult
        else
          echo "Skipping tests: no simulator destination available."
        fi

    # Create Archive
    - name: Create Archive
      run: |
        xcodebuild archive \
          -scheme 'Requestify-Package' \
          -destination 'generic/platform=iOS' \
          -archivePath $RUNNER_TEMP/Requestify.xcarchive \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO

    # Create IPA
    - name: Create IPA
      id: export_ipa
      continue-on-error: true
      run: |
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/Requestify.xcarchive \
          -exportPath $RUNNER_TEMP/Requestify \
          -exportOptionsPlist exportOptions.plist

    # Fallback: package unsigned IPA if export failed or signing not configured
    - name: Fallback - Package unsigned IPA
      if: steps.export_ipa.outcome != 'success'
      run: |
        set -e
        APP_DIR="$RUNNER_TEMP/Requestify.xcarchive/Products/Applications"
        mkdir -p "$RUNNER_TEMP/Requestify"
        if compgen -G "$APP_DIR/*.app" > /dev/null; then
          mkdir -p "$RUNNER_TEMP/RequestifyFallback/Payload"
          cp -R "$APP_DIR"/*.app "$RUNNER_TEMP/RequestifyFallback/Payload/"
          (cd "$RUNNER_TEMP/RequestifyFallback" && zip -r "$RUNNER_TEMP/Requestify/Requestify-unsigned.ipa" Payload)
          echo "Unsigned IPA created at $RUNNER_TEMP/Requestify/Requestify-unsigned.ipa"
        else
          echo "No .app found in archive. Skipping unsigned IPA packaging."
        fi

    # Upload IPA as artifact
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Requestify-iOS
        path: ${{ runner.temp }}/Requestify/*.ipa
        retention-days: 5
