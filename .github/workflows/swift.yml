# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: XCodeTest

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # Install any dependencies
    - name: Install Dependencies
      run: swift package resolve

    # Detect Xcode project (needed for archive/IPA)
    - name: Detect Xcode project
      id: detect
      shell: bash
      run: |
        shopt -s nullglob
        projs=(*.xcodeproj)
        if [ ${#projs[@]} -gt 0 ]; then
          echo "has_xcodeproj=true" >> "$GITHUB_OUTPUT"
          echo "Found Xcode project(s): ${projs[*]}"
        else
          echo "has_xcodeproj=false" >> "$GITHUB_OUTPUT"
          echo "No Xcode project found; archive/IPA steps will be skipped."
        fi

    # Build and Test using Swift Package Manager (macOS)
    - name: Build (SPM)
      run: swift build -v

    - name: Test (SPM, macOS)
      run: swift test --enable-code-coverage -v

    # Create Archive (only if an Xcode project exists)
    - name: Create Archive
      if: steps.detect.outputs.has_xcodeproj == 'true'
      shell: bash
      run: |
        APP_SCHEME=$(xcodebuild -list -json 2>/dev/null | /usr/bin/python3 -c 'import sys,json; d=json.load(sys.stdin); src=(d.get("project") or d.get("workspace") or {}); schemes=src.get("schemes",[]); print(next((s for s in schemes if "Tests" not in s and "Package" not in s), ""))')
        if [ -z "$APP_SCHEME" ]; then
          echo "No suitable app scheme found; skipping archive."
          exit 0
        fi
        echo "Archiving scheme: $APP_SCHEME"
        xcodebuild archive \
          -scheme "$APP_SCHEME" \
          -destination 'generic/platform=iOS' \
          -archivePath "$RUNNER_TEMP/Requestify.xcarchive" \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO

    # Create IPA
    - name: Create IPA
      if: steps.detect.outputs.has_xcodeproj == 'true'
      id: export_ipa
      continue-on-error: true
      run: |
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/Requestify.xcarchive \
          -exportPath $RUNNER_TEMP/Requestify \
          -exportOptionsPlist exportOptions.plist

    # Fallback: package unsigned IPA if export failed or signing not configured
    - name: Fallback - Package unsigned IPA
      if: steps.detect.outputs.has_xcodeproj == 'true' && steps.export_ipa.outcome != 'success'
      run: |
        set -e
        APP_DIR="$RUNNER_TEMP/Requestify.xcarchive/Products/Applications"
        mkdir -p "$RUNNER_TEMP/Requestify"
        if compgen -G "$APP_DIR/*.app" > /dev/null; then
          mkdir -p "$RUNNER_TEMP/RequestifyFallback/Payload"
          cp -R "$APP_DIR"/*.app "$RUNNER_TEMP/RequestifyFallback/Payload/"
          (cd "$RUNNER_TEMP/RequestifyFallback" && zip -r "$RUNNER_TEMP/Requestify/Requestify-unsigned.ipa" Payload)
          echo "Unsigned IPA created at $RUNNER_TEMP/Requestify/Requestify-unsigned.ipa"
        else
          echo "No .app found in archive. Skipping unsigned IPA packaging."
        fi

    # Upload IPA as artifact
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Requestify-iOS
        path: ${{ runner.temp }}/Requestify/*.ipa
        if-no-files-found: warn
        retention-days: 5
